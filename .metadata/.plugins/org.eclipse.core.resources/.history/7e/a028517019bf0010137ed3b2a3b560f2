#include "Dem.h"
#include "can.h"

const uint32_t Dem_PreDefined_DTC_Table[17u] =
{
		0x0100,
		0x0101,
		0x0102,
		0x0103,
		0x0104,
		0x0105,
		0x0106,
		0x0107,
		0x0108,
		0x0109,
		0x010A,
		0x010B,
		0x010C,
		0x010D,
		0x010E,
		0x010F,
};

uint8_t Dem_DTC_Stat[17u] = {0u};

extern uint8_t Dcm_CDTCS;

void Dem_SetDtc(uint32_t id, uint8_t stat);

void Dem_SetDtc(uint8_t id, uint8_t stat)
{
	uint8_t index = 0;
	uint8_t aux_index = 0xFFu;

	for(index = 0; index < sizeof(Dem_PreDefined_DTC_Table); index++)
	{
		if(id == Dem_PreDefined_DTC_Table[index])
		{
			aux_index = index;
			break;
		}
		else
		{
			/* Do nothing. */
		}
	}

	if(0xff != aux_index && 0u == Dcm_CDTCS)
	{
		Dem_DTC_Stat[aux_index] = stat;

		if(0x2f == stat)
		{
			static uint8_t arrtx[5];
			CAN_TxHeaderTypeDef TxHeader = {0u, 0u, 0u, 0u, 0u, 0u};
			uint32_t TxMailbox = 0u;

			arrtx[0] = (uint8_t)(Dem_PreDefined_DTC_Table[aux_index]);
			arrtx[1] = (uint8_t)(Dem_PreDefined_DTC_Table[aux_index] >> 8u);
			arrtx[2] = (uint8_t)(Dem_PreDefined_DTC_Table[aux_index] >> 16u);
			arrtx[3] = (uint8_t)(Dem_PreDefined_DTC_Table[aux_index] >> 24u);
			arrtx[4] = stat;
			TxHeader.DLC = 5;
			TxHeader.StdId = 0x7FEu;
			HAL_StatusTypeDef st;
			do {
				st = HAL_CAN_AddTxMessage(&hcan, &TxHeader, arrtx, &TxMailbox);
			} while (st != HAL_OK);   // wait until a mailbox frees up
			for(uint8_t i = 0; i < 5; i++) arrtx[i] = 0;
			TxHeader.DLC = 0;
			TxHeader.StdId = 0;
		}
	}
	else
	{
		/* Do nothing. */
	}


}
